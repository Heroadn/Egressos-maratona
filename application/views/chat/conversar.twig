{% extends "base.twig" %}

{% block title %}Timeline - {{ nome }}{% endblock %}

{% block body_class %}{% endblock %}

{% block header %}{% include "base/header.twig" %}{% endblock %}

{% block bread %}
    <div class="ui segment mini breadcrumb">
        <span class="section">Timeline</span>
        <i class="right chevron icon divider"></i>
        <span class="section">{{ nome }}</span>
    </div>
{% endblock %}

{% block footer %}{% include "base/footer.twig" %}{% endblock %}

{% block master_class %}ui grid{% endblock %}

{% block left_class %}sixteen wide mobile four wide tablet three wide computer centered column{% endblock %}

{% block mid_class %}sixteen wide mobile eight wide tablet seven wide computer centered column{% endblock %}

{% block right_class %}sixteen wide four four wide tablet four wide computer centered column{% endblock %}

{% block left_content %}
    <div class="row">
        {% include "usuario/conteudoEsquerda.twig" %}
        {% include 'usuario/menu_principal.twig' %}
    </div>
{% endblock %}

{% block content %}
    <div class="row">
        {% include 'chat/geradorChat.twig' %}
        <br>
        <div class="ui container">
            <span class="hidden" id="qtd_bd">{{ totalPosts|raw }}</span>
            <div class="ui segment">
                <h3 class="ui dividing header">{{ qtd|raw }} Chat</h3>
                <div class="mensagens"></div>
            </div>
        </div>
    </div>
    {#</div>#}

    <script>
        //Mensagem
        var messageInput = document.getElementById("conteudo");

        /*Se o usuario pressionar enter então a mensagem é enviada*/
        function handleKeyUp(e) {
            if (e.keyCode === 13) {
                sendMessage();
            }
        }

        function sendMessage() {
            var message = messageInput.value.trim();

            if (!message)
                return alert("Please write a message");

            var ajax = new XMLHttpRequest();
            ajax.open("POST", "/chat/conversar/", true);
            ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            ajax.send("conteudo=" + message);
            messageInput.value = "";
        }
 
        /* Gerenciando websocket*/
        window.WebSocket = window.WebSocket || window.MozWebSocket;
        var connection = new WebSocket('wss://socket.acid-software.net:443');


        connection.onopen = function () {
            //LOADING
        };

        connection.onerror = function (error) {
            connectingSpan.innerHTML = "Error occured: " +error;
            console.log(error);
        };

        connection.onmessage = function (message) {
            var data = JSON.parse(message.data);
            console.log("BLODY LOG: ");
            console.log(data);
            $('.mensagens').prepend(data.card);
        }
    </script>
{% endblock %}
